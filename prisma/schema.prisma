generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Currency {
  USD
  EUR
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum TransactionStatus {
  CANCELLED
  INITIATED
  FAILED
  SUCCESS
}

model User {
  id                String             @id @default(uuid())
  username          String             @unique
  email             String             @unique
  name              String
  passwordHash      String             @map("password_hash")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  wallet            Wallet?
  userVerifications UserVerification[]
  lastVerified      DateTime?

  @@map("users")
}

model Wallet {
  id           String        @id @default(uuid())
  user         User          @relation(fields: [userId], references: [id])
  userId       String        @unique @map("user_id")
  balance      Float
  currency     Currency
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  transactions Transaction[]

  @@map("wallets")
}

model Transaction {
  id             String            @id @default(uuid())
  idempotencyKey String            @map("idempotency_key")
  type           TransactionType
  amount         Float
  currency       Currency
  narration      String?
  status         TransactionStatus
  statusReason   String?           @map("status_reason")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  wallet         Wallet            @relation(fields: [walletId], references: [id])
  walletId       String            @map("wallet_id")

  @@unique([idempotencyKey, type])
  @@map("transactions")
}

model UserVerification {
  id            String   @id @default(uuid())
  otpCode       String
  otpExpiresAt  DateTime
  linkToken     String
  linkExpiresAt DateTime
  attempts      Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])
  userId        String   @map("user_id")

  @@map("user_verifications") // Maps to the actual table name in the database
}
